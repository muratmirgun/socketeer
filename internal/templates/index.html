<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socketeer - WebSocket API Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        :root {
            --color-bg: #f8fafc;
            --color-fg: #1e293b;
            --color-card: #ffffff;
            --color-border: #e2e8f0;
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-secondary: #64748b;
            --color-accent: #10b981;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --color-muted: #f1f5f9;
            --color-muted-fg: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
        }

        [data-theme="dark"] {
            --color-bg: #0f172a;
            --color-fg: #f1f5f9;
            --color-card: #1e293b;
            --color-border: #334155;
            --color-primary: #60a5fa;
            --color-primary-hover: #3b82f6;
            --color-secondary: #94a3b8;
            --color-accent: #34d399;
            --color-error: #f87171;
            --color-warning: #fbbf24;
            --color-muted: #334155;
            --color-muted-fg: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-muted) 100%);
            color: var(--color-fg);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-info {
            flex: 1;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-description {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .header-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            opacity: 0.8;
            flex-wrap: wrap;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-card);
            color: var(--color-fg);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-muted);
        }

        .btn-success {
            background: var(--color-accent);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-error {
            background: var(--color-error);
            color: white;
        }

        .btn-error:hover {
            background: #dc2626;
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-secondary);
        }

        .btn-ghost:hover {
            background: var(--color-muted);
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Card Styles */
        .card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: var(--color-secondary);
            font-size: 0.875rem;
        }

        /* Group Styles */
        .group {
            margin-bottom: 2rem;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: var(--color-muted);
            border-radius: var(--radius) var(--radius) 0 0;
            transition: background 0.2s;
        }

        .group-header:hover {
            background: var(--color-border);
        }

        .group-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .group-content {
            display: none;
            padding: 1rem;
            background: var(--color-card);
            border-radius: 0 0 var(--radius) var(--radius);
            border: 1px solid var(--color-border);
            border-top: none;
        }

        .group-content.open {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Socket Styles */
        .socket {
            margin-bottom: 1.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .socket-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: var(--color-muted);
            transition: background 0.2s;
        }

        .socket-header:hover {
            background: var(--color-border);
        }

        .socket-icon {
            font-size: 1.5rem;
        }

        .socket-info {
            flex: 1;
        }

        .socket-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .socket-url {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--color-secondary);
        }

        .socket-tags {
            display: flex;
            gap: 0.5rem;
        }

        .socket-content {
            display: none;
            padding: 1.5rem;
            background: var(--color-card);
        }

        .socket-content.open {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            background: var(--color-muted);
            color: var(--color-fg);
        }

        .badge-primary {
            background: var(--color-primary);
            color: white;
        }

        .badge-success {
            background: var(--color-accent);
            color: white;
        }

        .badge-error {
            background: var(--color-error);
            color: white;
        }

        .badge-outline {
            background: transparent;
            border: 1px solid var(--color-border);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-fg);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            background: var(--color-card);
            color: var(--color-fg);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            background: var(--color-card);
            color: var(--color-fg);
            font-size: 0.875rem;
        }

        /* Tab Styles */
        .tabs {
            margin-bottom: 1.5rem;
        }

        .tab-list {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--color-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Code Styles */
        .code-block {
            background: var(--color-muted);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Client Styles */
        .client-panel {
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            background: var(--color-card);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .client-actions {
            display: flex;
            gap: 0.5rem;
        }

        .client-content {
            padding: 1.5rem;
        }

        .status-indicator {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-connected {
            background: var(--color-accent);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: var(--color-error);
        }

        .status-connecting {
            background: var(--color-warning);
            animation: pulse 1s infinite;
        }

        /* Log Styles */
        .log-container {
            background: var(--color-muted);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }

        .log-entry {
            margin-bottom: 0.25rem;
            word-break: break-all;
        }

        .log-timestamp {
            color: var(--color-muted-fg);
            margin-right: 0.5rem;
        }

        .log-in {
            color: var(--color-primary);
            font-weight: 500;
        }

        .log-out {
            color: var(--color-accent);
            font-weight: 500;
        }

        .log-error {
            color: var(--color-error);
            font-weight: 500;
        }

        .log-info {
            color: var(--color-secondary);
        }

        /* Message Styles */
        .message-section {
            background: var(--color-muted);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .message-icon {
            font-size: 1.25rem;
            color: var(--color-primary);
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* Grid Styles */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        /* Utility Classes */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }

        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }

        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .hidden { display: none; }
        .block { display: block; }

        /* Collapsible */
        .collapser {
            font-size: 1.1rem;
            color: var(--color-primary);
            margin-right: 0.5rem;
            user-select: none;
            transition: transform 0.2s;
        }

        .collapser.open {
            transform: rotate(90deg);
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: none;
            background: var(--color-card);
            color: var(--color-fg);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            font-size: 1.1rem;
            color: var(--color-secondary);
        }

        .loading::before {
            content: '';
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.5rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-title {
                font-size: 2rem;
            }

            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .socket-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .client-header {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="theme-icon">🌙</span>
    </button>

    <div class="container">
        <!-- Header -->
        <div id="api-info" class="header">
            <div class="loading">Loading WebSocket API documentation...</div>
        </div>

        <!-- API Groups -->
        <div id="api-groups"></div>
    </div>

    <script>
        // Global state
        let clients = {};
        let expandedGroups = new Set();
        let expandedSockets = new Set();

        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('socketeer-theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('socketeer-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '☀️' : '🌙';
        }

        // Utility functions
        function getSocketIcon(name) {
            const lowerName = name.toLowerCase();
            if (lowerName.includes('chat')) return '💬';
            if (lowerName.includes('notify')) return '🔔';
            if (lowerName.includes('update')) return '🔄';
            if (lowerName.includes('ping')) return '🏓';
            return '🔗';
        }

        function formatTimestamp() {
            return new Date().toLocaleTimeString();
        }

        function validateJson(jsonString) {
            try {
                JSON.parse(jsonString);
                return true;
            } catch {
                return false;
            }
        }

        function getWsUrl(pathOrUrl) {
            // If already absolute ws:// or wss://, use as is
            if (/^wss?:\/\//.test(pathOrUrl)) return pathOrUrl;
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            return `${proto}://${window.location.host}${pathOrUrl.startsWith('/') ? pathOrUrl : '/' + pathOrUrl}`;
        }

        // Group management
        function toggleGroup(groupName) {
            const content = document.getElementById(`group-content-${groupName}`);
            const icon = document.getElementById(`group-icon-${groupName}`);
            
            if (expandedGroups.has(groupName)) {
                expandedGroups.delete(groupName);
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                expandedGroups.add(groupName);
                content.classList.add('open');
                icon.classList.add('open');
            }
        }

        // Socket management
        function toggleSocket(socketId) {
            const content = document.getElementById(`socket-content-${socketId}`);
            const icon = document.getElementById(`socket-icon-${socketId}`);
            
            if (expandedSockets.has(socketId)) {
                expandedSockets.delete(socketId);
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                expandedSockets.add(socketId);
                content.classList.add('open');
                icon.classList.add('open');
            }
        }

        // Tab management
        function switchTab(tabGroup, tabName) {
            // Hide all tab contents in this group
            const tabContents = document.querySelectorAll(`[data-tab-group="${tabGroup}"]`);
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons in this group
            const tabButtons = document.querySelectorAll(`[data-tab-button-group="${tabGroup}"]`);
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            const selectedContent = document.getElementById(`${tabGroup}-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }

            // Add active class to selected tab button
            const selectedButton = document.querySelector(`[data-tab-button-group="${tabGroup}"][data-tab="${tabName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }

        // Message toggle functions
        function toggleMessages(btn) {
            const section = btn.nextElementSibling;
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = 'Hide Messages';
            } else {
                section.style.display = 'none';
                btn.textContent = 'Show Messages';
            }
        }

        function toggleExample(btn) {
            const pre = btn.nextElementSibling;
            if (pre.style.display === 'none') {
                pre.style.display = 'block';
                btn.textContent = 'Hide Payload & Example';
            } else {
                pre.style.display = 'none';
                btn.textContent = 'Show Payload & Example';
            }
        }

        // Client management - Bu fonksiyonu tamamen değiştir
        function addClient(socketIndex) {
            const clientId = Date.now();
            if (!clients[socketIndex]) {
                clients[socketIndex] = [];
            }

            const client = {
                id: clientId,
                ws: null,
                connected: false,
                recording: false,
                trafficLog: []
            };

            clients[socketIndex].push(client);
            
            // Sadece yeni client'ı ekle, mevcut olanları yeniden render etme
            appendNewClient(socketIndex, client);
        }

        // Yeni fonksiyon ekle - renderClients fonksiyonundan önce
        function appendNewClient(socketIndex, client) {
            const container = document.getElementById(`clients-${socketIndex}`);
            if (!container) return;

            // İlk client ise container'ı temizle
            if (clients[socketIndex].length === 1) {
                container.innerHTML = '';
            }

            // Yeni client panel'ini oluştur
            const clientPanel = document.createElement('div');
            clientPanel.className = 'client-panel';
            clientPanel.id = `client-panel-${socketIndex}-${client.id}`;
            clientPanel.innerHTML = renderClientContent(socketIndex, client.id);
            
            container.appendChild(clientPanel);
            
            // Event listener'ları ekle
            setupClientEventListeners(socketIndex, client.id);
            
            // Scroll to new client
            setTimeout(() => {
                clientPanel.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 100);
        }

        // Yeni fonksiyon ekle - Event listener'ları ayarlamak için
        function setupClientEventListeners(socketIndex, clientId) {
            const socket = window.apiSpec.sockets[socketIndex];
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (!client) return;

            // DOM elementlerini al
            const connectBtn = document.getElementById(`connect-${socketIndex}-${clientId}`);
            const sendBtn = document.getElementById(`send-${socketIndex}-${clientId}`);
            const closeBtn = document.getElementById(`disconnect-${socketIndex}-${clientId}`);
            const payloadInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            const statusEl = document.getElementById(`status-${socketIndex}-${clientId}`);
            const recBtn = document.getElementById(`record-${socketIndex}-${clientId}`);
            const removeBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-error[title="Remove Client"]`);

            // Connect button
            connectBtn.onclick = (e) => {
                e.preventDefault();
                connectClient(socketIndex, clientId);
            };

            // Send button
            sendBtn.onclick = (e) => {
                e.preventDefault();
                sendMessage(socketIndex, clientId);
            };

            // Disconnect button
            closeBtn.onclick = (e) => {
                e.preventDefault();
                disconnectClient(socketIndex, clientId);
            };

            // Record button
            recBtn.onclick = () => {
                toggleRecording(socketIndex, clientId);
            };

            // Remove button
            removeBtn.onclick = () => {
                removeClient(socketIndex, clientId);
            };

            // Template load button
            const templateBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-secondary`);
            if (templateBtn && templateBtn.textContent.includes('Load Template')) {
                templateBtn.onclick = () => {
                    loadTemplate(socketIndex, clientId);
                };
            }

            // Format, copy, clear buttons
            const formatBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-ghost[title="Format JSON"]`);
            const copyBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-ghost[title="Copy"]`);
            const clearBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-ghost[title="Clear"]`);
            const clearLogBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-ghost:last-of-type`);

            if (formatBtn) formatBtn.onclick = () => formatJson(socketIndex, clientId);
            if (copyBtn) copyBtn.onclick = () => copyMessage(socketIndex, clientId);
            if (clearBtn) clearBtn.onclick = () => clearMessage(socketIndex, clientId);
            if (clearLogBtn) clearLogBtn.onclick = () => clearLog(socketIndex, clientId);

            // Export traffic button
            const exportBtn = document.querySelector(`#client-panel-${socketIndex}-${clientId} .btn-ghost[title="Export Traffic"]`);
            if (exportBtn) exportBtn.onclick = () => exportTraffic(socketIndex, clientId);
        }

        // removeClient fonksiyonunu güncelle
        function removeClient(socketIndex, clientId) {
            if (clients[socketIndex]) {
                const clientIndex = clients[socketIndex].findIndex(c => c.id === clientId);
                if (clientIndex !== -1) {
                    const client = clients[socketIndex][clientIndex];
                    if (client.ws) {
                        client.ws.close();
                    }
                    clients[socketIndex].splice(clientIndex, 1);
            
                    // DOM'dan client panel'ini kaldır
                    const clientPanel = document.getElementById(`client-panel-${socketIndex}-${clientId}`);
                    if (clientPanel) {
                        clientPanel.remove();
                    }
            
                    // Eğer hiç client kalmadıysa placeholder göster
                    if (clients[socketIndex].length === 0) {
                        const container = document.getElementById(`clients-${socketIndex}`);
                        if (container) {
                            container.innerHTML = `
                                <div class="alert alert-info">
                                    No clients connected. Add a client to start testing this WebSocket endpoint.
                                </div>
                            `;
                        }
                    }
                }
            }
        }

        // renderClients fonksiyonunu basitleştir - sadece ilk yükleme için
        function renderClients(socketIndex) {
            const container = document.getElementById(`clients-${socketIndex}`);
            if (!container) return;

            const socketClients = clients[socketIndex] || [];
            
            if (socketClients.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        No clients connected. Add a client to start testing this WebSocket endpoint.
                    </div>
                `;
                return;
            }

            // Mevcut client'ları koru, sadece eksik olanları ekle
            socketClients.forEach(client => {
                const existingPanel = document.getElementById(`client-panel-${socketIndex}-${client.id}`);
                if (!existingPanel) {
                    appendNewClient(socketIndex, client);
                }
            });
        }

        // renderClientContent fonksiyonunda onclick handler'ları kaldır
        function renderClientContent(socketIndex, clientId) {
            const socket = window.apiSpec.sockets[socketIndex];
            
            return `
        <div class="client-header">
            <div class="client-info">
                <div id="status-${socketIndex}-${clientId}" class="flex items-center">
                    <div class="status-indicator status-disconnected"></div>
                    <span class="status-text">Disconnected</span>
                </div>
                <span class="font-medium">Client #${clientId}</span>
            </div>
            <div class="client-actions">
                <button id="record-${socketIndex}-${clientId}" class="btn btn-secondary btn-sm">
                    🔴 Start Recording
                </button>
                <button class="btn btn-ghost btn-sm" title="Export Traffic">
                    📥
                </button>
                <button class="btn btn-error btn-sm" title="Remove Client">
                    🗑️
                </button>
            </div>
        </div>
        <div class="client-content">
            <!-- Connection Parameters -->
            ${socket.connectionParams && socket.connectionParams.length > 0 ? `
                <div class="grid grid-cols-2 mb-4">
                    ${socket.connectionParams.map(param => `
                        <div class="form-group">
                            <label class="form-label" for="param-${socketIndex}-${clientId}-${param.name}">
                                ${param.name} ${param.required ? '<span style="color: var(--color-error)">*</span>' : ''}
                            </label>
                            <input 
                                type="text" 
                                id="param-${socketIndex}-${clientId}-${param.name}"
                                class="form-input"
                                placeholder="${param.description}"
                                ${param.required ? 'required' : ''}
                            />
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            <!-- Connection Controls -->
            <div class="flex gap-2 mb-4">
                <button id="connect-${socketIndex}-${clientId}" class="btn btn-success">
                    ▶️ Connect
                </button>
                <button id="disconnect-${socketIndex}-${clientId}" class="btn btn-error" disabled>
                    ⏹️ Disconnect
                </button>
            </div>

            <!-- Message Sending -->
            <div class="message-section">
                <div class="message-header">
                    <div class="message-icon">💬</div>
                    <h5 class="font-semibold">Send Message</h5>
                </div>

                ${socket.groupedMessages && socket.groupedMessages.filter(msg => msg.send).length > 0 ? `
                    <div class="form-group">
                        <label class="form-label">Message Template</label>
                        <div class="flex gap-2">
                            <select id="template-${socketIndex}-${clientId}" class="form-select" style="flex: 1;">
                                <option value="">Select message type...</option>
                                ${socket.groupedMessages.filter(msg => msg.send).map(msg => `
                                    <option value="${msg.type}">${msg.type} - ${msg.description}</option>
                                `).join('')}
                            </select>
                            <button class="btn btn-secondary">
                                Load Template
                            </button>
                        </div>
                    </div>
                ` : ''}

                <div class="form-group">
                    <div class="flex justify-between items-center mb-2">
                        <label class="form-label">Message Payload</label>
                        <div class="flex gap-1">
                            <button class="btn btn-ghost btn-sm" title="Format JSON">
                                🎨
                            </button>
                            <button class="btn btn-ghost btn-sm" title="Copy">
                                📋
                            </button>
                            <button class="btn btn-ghost btn-sm" title="Clear">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <textarea 
                        id="message-${socketIndex}-${clientId}"
                        class="form-input form-textarea"
                        placeholder="Enter JSON message payload..."
                    >{}</textarea>
                </div>

                <button id="send-${socketIndex}-${clientId}" class="btn btn-primary" disabled>
                    📤 Send Message
                </button>
            </div>

            <!-- Connection Log -->
            <div class="form-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="form-label">Connection Log</label>
                    <button class="btn btn-ghost btn-sm">
                        Clear
                    </button>
                </div>
                <div id="log-${socketIndex}-${clientId}" class="log-container">
                    <div class="log-entry">
                        <span class="log-timestamp">[${formatTimestamp()}]</span>
                        <span class="log-info">Ready to connect...</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

        // `init()` fonksiyonundan önce, eksik fonksiyonları ekle:

        function connectClient(socketIndex, clientId) {
            const socket = window.apiSpec.sockets[socketIndex];
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (!client) return;

            // Get connection parameters
            const params = {};
            if (socket.connectionParams) {
                socket.connectionParams.forEach(param => {
                    const input = document.getElementById(`param-${socketIndex}-${clientId}-${param.name}`);
                    if (input) {
                        params[param.name] = input.value;
                    }
                });
            }

            // Build WebSocket URL
            let wsUrl = socket.url;
            const queryParams = new URLSearchParams();
            Object.entries(params).forEach(([key, value]) => {
                if (value) queryParams.append(key, value);
            });
            
            if (queryParams.toString()) {
                wsUrl += '?' + queryParams.toString();
            }

            const fullUrl = getWsUrl(wsUrl);

            // Create WebSocket connection
            try {
                client.ws = new WebSocket(fullUrl);
                updateClientStatus(socketIndex, clientId, 'connecting');
                addLog(socketIndex, clientId, 'info', 'Connecting to ' + fullUrl);

                client.ws.onopen = () => {
                    client.connected = true;
                    updateClientStatus(socketIndex, clientId, 'connected');
                    addLog(socketIndex, clientId, 'info', '✅ Connected successfully');
                };

                client.ws.onmessage = (event) => {
                    addLog(socketIndex, clientId, 'in', `Received: ${event.data}`);
                    if (client.recording) {
                        client.trafficLog.push({
                            timestamp: new Date().toISOString(),
                            direction: 'in',
                            payload: event.data
                        });
                    }
                };

                client.ws.onclose = (event) => {
                    client.connected = false;
                    client.ws = null;
                    updateClientStatus(socketIndex, clientId, 'disconnected');
                    addLog(socketIndex, clientId, 'info', `❌ Connection closed (Code: ${event.code})`);
                };

                client.ws.onerror = () => {
                    addLog(socketIndex, clientId, 'error', '❌ WebSocket error occurred');
                };

            } catch (error) {
                addLog(socketIndex, clientId, 'error', `Connection failed: ${error.message}`);
            }
        }

        function disconnectClient(socketIndex, clientId) {
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (client && client.ws) {
                client.ws.close();
            }
        }

        function sendMessage(socketIndex, clientId) {
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (!client || !client.connected) {
                addLog(socketIndex, clientId, 'error', 'Not connected to WebSocket');
                return;
            }

            const messageInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            const message = messageInput.value.trim();

            if (!message) {
                addLog(socketIndex, clientId, 'error', 'Message cannot be empty');
                return;
            }

            if (!validateJson(message)) {
                addLog(socketIndex, clientId, 'error', 'Invalid JSON format');
                return;
            }

            try {
                client.ws.send(message);
                addLog(socketIndex, clientId, 'out', `Sent: ${message}`);
                
                if (client.recording) {
                    client.trafficLog.push({
                        timestamp: new Date().toISOString(),
                        direction: 'out',
                        payload: message
                    });
                }
            } catch (error) {
                addLog(socketIndex, clientId, 'error', `Send failed: ${error.message}`);
            }
        }

        function updateClientStatus(socketIndex, clientId, status) {
            const statusElement = document.getElementById(`status-${socketIndex}-${clientId}`);
            const connectButton = document.getElementById(`connect-${socketIndex}-${clientId}`);
            const disconnectButton = document.getElementById(`disconnect-${socketIndex}-${clientId}`);
            const sendButton = document.getElementById(`send-${socketIndex}-${clientId}`);

            if (statusElement) {
                const indicator = statusElement.querySelector('.status-indicator');
                const text = statusElement.querySelector('.status-text');

                indicator.className = `status-indicator status-${status}`;
                
                switch (status) {
                    case 'connected':
                        text.textContent = 'Connected';
                        connectButton.disabled = true;
                        disconnectButton.disabled = false;
                        sendButton.disabled = false;
                        break;
                    case 'connecting':
                        text.textContent = 'Connecting...';
                        connectButton.disabled = true;
                        disconnectButton.disabled = false;
                        sendButton.disabled = true;
                        break;
                    case 'disconnected':
                        text.textContent = 'Disconnected';
                        connectButton.disabled = false;
                        disconnectButton.disabled = true;
                        sendButton.disabled = true;
                        break;
                }
            }
        }

        function addLog(socketIndex, clientId, type, message) {
            const logContainer = document.getElementById(`log-${socketIndex}-${clientId}`);
            if (!logContainer) return;

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'log-timestamp';
            timestamp.textContent = `[${formatTimestamp()}]`;
            
            const content = document.createElement('span');
            content.className = `log-${type}`;
            content.textContent = message;
            
            logEntry.appendChild(timestamp);
            logEntry.appendChild(content);
            logContainer.appendChild(logEntry);
            
            // Auto-scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function toggleRecording(socketIndex, clientId) {
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (!client) return;

            client.recording = !client.recording;
            const button = document.getElementById(`record-${socketIndex}-${clientId}`);
            
            if (client.recording) {
                button.textContent = '⏹️ Stop Recording';
                button.classList.add('btn-error');
                button.classList.remove('btn-secondary');
                addLog(socketIndex, clientId, 'info', 'Started recording traffic');
            } else {
                button.textContent = '🔴 Start Recording';
                button.classList.add('btn-secondary');
                button.classList.remove('btn-error');
                addLog(socketIndex, clientId, 'info', 'Stopped recording traffic');
            }
        }

        function exportTraffic(socketIndex, clientId) {
            const client = clients[socketIndex]?.find(c => c.id === clientId);
            if (!client || client.trafficLog.length === 0) {
                addLog(socketIndex, clientId, 'error', 'No traffic data to export');
                return;
            }

            const blob = new Blob([JSON.stringify(client.trafficLog, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `websocket-traffic-${clientId}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog(socketIndex, clientId, 'info', 'Traffic data exported');
        }

        function loadTemplate(socketIndex, clientId) {
            const socket = window.apiSpec.sockets[socketIndex];
            const select = document.getElementById(`template-${socketIndex}-${clientId}`);
            const messageInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            
            const selectedType = select.value;
            if (!selectedType) return;

            const messageType = socket.groupedMessages?.find(msg => msg.type === selectedType);
            if (messageType && messageType.send && messageType.send.example) {
                const template = JSON.stringify(messageType.send.example, null, 2);
                messageInput.value = template;
                addLog(socketIndex, clientId, 'info', `Template loaded: ${selectedType}`);
            }
        }

        function formatJson(socketIndex, clientId) {
            const messageInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            try {
                const parsed = JSON.parse(messageInput.value);
                messageInput.value = JSON.stringify(parsed, null, 2);
                addLog(socketIndex, clientId, 'info', 'JSON formatted');
            } catch {
                addLog(socketIndex, clientId, 'error', 'Invalid JSON - cannot format');
            }
        }

        function copyMessage(socketIndex, clientId) {
            const messageInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            navigator.clipboard.writeText(messageInput.value).then(() => {
                addLog(socketIndex, clientId, 'info', 'Message copied to clipboard');
            }).catch(() => {
                addLog(socketIndex, clientId, 'error', 'Failed to copy message');
            });
        }

        function clearMessage(socketIndex, clientId) {
            const messageInput = document.getElementById(`message-${socketIndex}-${clientId}`);
            messageInput.value = '{}';
            addLog(socketIndex, clientId, 'info', 'Message cleared');
        }

        function clearLog(socketIndex, clientId) {
            const logContainer = document.getElementById(`log-${socketIndex}-${clientId}`);
            if (logContainer) {
                logContainer.innerHTML = '';
                addLog(socketIndex, clientId, 'info', 'Log cleared');
            }
        }

        function copyYaml() {
            fetch('/wsapi.yaml')
                .then(r => r.text())
                .then(txt => {
                    navigator.clipboard.writeText(txt).then(() => {
                        showNotification('YAML copied to clipboard!', 'success');
                    });
                })
                .catch(() => {
                    showNotification('Failed to copy YAML', 'error');
                });
        }

        function downloadYaml() {
            fetch('/wsapi.yaml')
                .then(r => r.text())
                .then(txt => {
                    const blob = new Blob([txt], { type: 'text/yaml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'wsapi.yaml';
                    a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(() => {
                    showNotification('Failed to download YAML', 'error');
                });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '80px';
            notification.style.right = '1rem';
            notification.style.zIndex = '1001';
            notification.style.minWidth = '300px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function renderAPI(spec) {
            // Store spec globally for client functions
            window.apiSpec = spec;

            // Render API info header
            const info = spec.info || {};
            const apiInfoEl = document.getElementById('api-info');
            apiInfoEl.innerHTML = `
                <div class="header-content">
                    <div class="header-info">
                        <h1 class="header-title">${info.title || 'WebSocket API Documentation'}</h1>
                        <p class="header-description">${info.description || ''}</p>
                        <div class="header-meta">
                            <span><strong>Version:</strong> ${info.version || ''}</span>
                            ${info.contact && (info.contact.name || info.contact.email) ? `<span><strong>Contact:</strong> ${info.contact.name || ''}${info.contact.email ? ' <' + info.contact.email + '>' : ''}</span>` : ''}
                            ${info.license && (info.license.name || info.license.url) ? `<span><strong>License:</strong> ${info.license.url ? `<a href='${info.license.url}' target='_blank' style='color:white;text-decoration:underline;'>${info.license.name || info.license.url}</a>` : info.license.name}</span>` : ''}
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-sm" onclick="copyYaml()">
                            📋 Copy YAML
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadYaml()">
                            📥 Download
                        </button>
                    </div>
                </div>
            `;

            const container = document.getElementById('api-groups');
            
            if (!spec.sockets || !spec.sockets.length) {
                container.innerHTML = '<div class="alert alert-info">No WebSocket endpoints found.</div>';
                return;
            }

            // Group sockets by group
            const groupedSockets = {};
            spec.sockets.forEach((socket, index) => {
                const group = socket.group || 'Ungrouped';
                if (!groupedSockets[group]) {
                    groupedSockets[group] = [];
                }
                groupedSockets[group].push({ socket, index });
            });

            container.innerHTML = Object.entries(groupedSockets).map(([groupName, sockets]) => `
                <div class="group card">
                    <div class="group-header" onclick="toggleGroup('${groupName}')">
                        <div class="collapser" id="group-icon-${groupName}">▶</div>
                        <h2 class="group-title">${groupName}</h2>
                        <div class="badge">${sockets.length} endpoints</div>
                    </div>
                    <div id="group-content-${groupName}" class="group-content">
                        ${sockets.map(({ socket, index }) => renderSocket(socket, index, groupName)).join('')}
                    </div>
                </div>
            `).join('');

            // Auto-expand first group
            const firstGroup = Object.keys(groupedSockets)[0];
            if (firstGroup) {
                setTimeout(() => toggleGroup(firstGroup), 100);
            }
        }

        function renderSocket(socket, index, groupName) {
            const socketId = `${groupName}-${index}`;
            const icon = getSocketIcon(socket.name);

            return `
                <div class="socket">
                    <div class="socket-header" onclick="toggleSocket('${socketId}')">
                        <div class="collapser" id="socket-icon-${socketId}">▶</div>
                        <div class="socket-icon">${icon}</div>
                        <div class="socket-info">
                            <div class="socket-name">${socket.name}</div>
                            <div class="socket-url">${socket.url}</div>
                        </div>
                        <div class="socket-tags">
                            ${(socket.tags || []).map(tag => `<span class="badge">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div id="socket-content-${socketId}" class="socket-content">
                        ${renderSocketContent(socket, index)}
                    </div>
                </div>
            `;
        }

        function renderSocketContent(socket, index) {
            return `
                <!-- Description -->
                ${socket.description ? `<p class="mb-4 card-description">${socket.description}</p>` : ''}

                <!-- Connection Parameters -->
                ${socket.connectionParams && socket.connectionParams.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold mb-3">Connection Parameters</h4>
                        <div class="grid gap-2">
                            ${socket.connectionParams.map(param => `
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="badge ${param.required ? 'badge-error' : ''}">${param.name}</span>
                                    <span class="card-description">${param.type} • ${param.in} • ${param.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Messages -->
                <div class="mb-4">
                    <button class="btn btn-secondary btn-sm mb-3" onclick="toggleMessages(this)">Show Messages</button>
                    <div style="display:none">
                        ${socket.groupedMessages && socket.groupedMessages.length > 0 ? `
                            <div class="grid gap-4">
                                ${socket.groupedMessages.map(msg => `
                                    <div class="card" style="border-left: 4px solid var(--color-primary);">
                                        <div class="card-header">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="badge badge-primary">${msg.type}</span>
                                                ${msg.send ? '<span class="badge badge-success">Send</span>' : ''}
                                                ${msg.receive ? '<span class="badge" style="background: #dbeafe; color: #1e40af;">Receive</span>' : ''}
                                            </div>
                                            <p class="card-description">${msg.description}</p>
                                        </div>
                                        <div class="card-content">
                                            <button class="btn btn-ghost btn-sm mb-3" onclick="toggleExample(this)">Show Payload & Example</button>
                                            <div style="display:none">
                                                ${msg.send ? `
                                                    <div class="mb-4">
                                                        <h5 class="font-medium mb-2" style="color: var(--color-accent);">Send Payload</h5>
                                                        <div class="code-block">${JSON.stringify(msg.send.payload, null, 2)}</div>
                                                        ${msg.send.example ? `
                                                            <h5 class="font-medium mb-2 mt-3" style="color: var(--color-accent);">Send Example</h5>
                                                            <div class="code-block">${JSON.stringify(msg.send.example, null, 2)}</div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                                ${msg.receive ? `
                                                    <div>
                                                        <h5 class="font-medium mb-2" style="color: var(--color-primary);">Receive Payload</h5>
                                                        <div class="code-block">${JSON.stringify(msg.receive.payload, null, 2)}</div>
                                                        ${msg.receive.example ? `
                                                            <h5 class="font-medium mb-2 mt-3" style="color: var(--color-primary);">Receive Example</h5>
                                                            <div class="code-block">${JSON.stringify(msg.receive.example, null, 2)}</div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="alert alert-info">No messages defined for this endpoint.</div>'}
                    </div>
                </div>

                <!-- Playground -->
                <div>
                    <h4 class="font-semibold mb-3">Playground</h4>
                    <div class="card" style="border: 2px dashed var(--color-border);">
                        <div class="card-content">
                            <div class="tabs">
                                <div class="tab-list">
                                    <button class="tab-button" data-tab-button-group="playground-${index}" data-tab="example" onclick="switchTab('playground-${index}', 'example')">Example</button>
                                    <button class="tab-button active" data-tab-button-group="playground-${index}" data-tab="test" onclick="switchTab('playground-${index}', 'test')">Test</button>
                                </div>
                                <div id="playground-${index}-example" class="tab-content" data-tab-group="playground-${index}">
                                    <div class="code-block" style="height: 200px;">
                                        ${JSON.stringify(socket.groupedMessages?.[0]?.send?.example || {}, null, 2)}
                                    </div>
                                </div>
                                <div id="playground-${index}-test" class="tab-content active" data-tab-group="playground-${index}">
                                    <div class="flex justify-between items-center mb-4">
                                        <h5 class="font-medium">WebSocket Clients</h5>
                                        <button class="btn btn-success btn-sm" onclick="addClient(${index})">
                                            ➕ Add Client
                                        </button>
                                    </div>
                                    <div id="clients-${index}">
                                        <div class="alert alert-info">
                                            No clients connected. Add a client to start testing this WebSocket endpoint.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize the application
        function init() {
            initTheme();
            
            // Load YAML and render API
            fetch('/wsapi.yaml')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(yamlText => {
                    const spec = jsyaml.load(yamlText);
                    renderAPI(spec);
                })
                .catch(error => {
                    console.error('Error loading YAML:', error);
                    document.getElementById('api-info').innerHTML = `
                        <div class="alert alert-error">
                            <strong>Error loading WebSocket API specification:</strong><br>
                            ${error.message}<br><br>
                            Please ensure that <code>wsapi.yaml</code> file exists and is accessible.
                        </div>
                    `;
                });
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
